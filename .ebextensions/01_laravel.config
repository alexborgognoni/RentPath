option_settings:
  aws:elasticbeanstalk:container:php:phpini:
    document_root: "/public"
    memory_limit: "512M"
    max_execution_time: "300"
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/99_create_storage_dirs.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      mkdir -p /var/app/current/storage/logs
      mkdir -p /var/app/current/storage/framework/cache/data
      mkdir -p /var/app/current/storage/framework/sessions
      mkdir -p /var/app/current/storage/framework/views
      mkdir -p /var/app/current/bootstrap/cache

container_commands:
  01_install_dependencies:
    command: "composer install --no-dev --optimize-autoloader"
    cwd: "/var/app/staging"

  02_clear_caches:
    command: |
      php artisan config:clear --no-interaction
      php artisan route:clear --no-interaction
      php artisan view:clear --no-interaction
      php artisan cache:clear --no-interaction
    cwd: "/var/app/staging"

  03_set_permissions:
    command: "chmod -R 775 /var/app/current/storage /var/app/current/bootstrap/cache"

  04_migrate:
    command: "php artisan migrate --force --no-interaction || echo 'Migration skipped - database not ready'"
    cwd: "/var/app/current"
    leader_only: true
